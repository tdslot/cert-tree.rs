---
name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # Validate that the tag matches the version in Cargo.toml
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version from tag: ${VERSION}"

      - name: Get version from Cargo.toml
        id: cargo_version
        run: |
          CARGO_VERSION=$(grep '^version =' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "cargo_version=${CARGO_VERSION}" >> $GITHUB_OUTPUT
          echo "Version from Cargo.toml: ${CARGO_VERSION}"

      - name: Validate versions match
        run: |
          if [ "${{ steps.get_version.outputs.version }}" != "${{ steps.cargo_version.outputs.cargo_version }}" ]; then
            echo "âŒ Error: Tag version (${{ steps.get_version.outputs.version }}) does not match Cargo.toml version (${{ steps.cargo_version.outputs.cargo_version }})"
            exit 1
          fi
          echo "âœ… Versions match: ${{ steps.get_version.outputs.version }}"

  # Build Linux binary
  build-linux:
    name: Build for Linux x86_64
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --target x86_64-unknown-linux-gnu

      - name: Strip binary
        run: strip target/x86_64-unknown-linux-gnu/release/cert-tree

      - name: Create archive
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p cert-tree-linux-x86_64
          cp target/x86_64-unknown-linux-gnu/release/cert-tree cert-tree-linux-x86_64/
          cp README.md LICENSE cert-tree-linux-x86_64/
          tar -czf cert-tree-${VERSION}-linux-x86_64.tar.gz cert-tree-linux-x86_64/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: cert-tree-*-linux-x86_64.tar.gz
          if-no-files-found: error

  # Build macOS Intel binary
  build-macos-intel:
    name: Build for macOS x86_64
    needs: validate
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-x86_64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --target x86_64-apple-darwin

      - name: Strip binary
        run: strip target/x86_64-apple-darwin/release/cert-tree || true

      - name: Create archive
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p cert-tree-macos-x86_64
          cp target/x86_64-apple-darwin/release/cert-tree cert-tree-macos-x86_64/
          cp README.md LICENSE cert-tree-macos-x86_64/
          tar -czf cert-tree-${VERSION}-macos-x86_64.tar.gz cert-tree-macos-x86_64/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-binary
          path: cert-tree-*-macos-x86_64.tar.gz
          if-no-files-found: error

  # Build macOS ARM binary
  build-macos-arm:
    name: Build for macOS ARM64
    needs: validate
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-aarch64-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --target aarch64-apple-darwin

      - name: Strip binary
        run: strip target/aarch64-apple-darwin/release/cert-tree || true

      - name: Create archive
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          mkdir -p cert-tree-macos-aarch64
          cp target/aarch64-apple-darwin/release/cert-tree cert-tree-macos-aarch64/
          cp README.md LICENSE cert-tree-macos-aarch64/
          tar -czf cert-tree-${VERSION}-macos-aarch64.tar.gz cert-tree-macos-aarch64/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-binary
          path: cert-tree-*-macos-aarch64.tar.gz
          if-no-files-found: error

  # Build RPM packages
  build-rpm:
    name: Build RPM for ${{ matrix.distro }}
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - distro: centos
            container: quay.io/centos/centos:stream9
            package_manager: yum
          - distro: rocky
            container: rockylinux:9
            package_manager: dnf
          - distro: alma
            container: almalinux:9
            package_manager: dnf
    container: ${{ matrix.container }}
    steps:
      - name: Install dependencies
        run: |
          ${{ matrix.package_manager }} update -y
          ${{ matrix.package_manager }} install -y --allowerasing curl gcc make openssl-devel
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . $HOME/.cargo/env
          cargo install cargo-generate-rpm

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release
        run: |
          . $HOME/.cargo/env
          cargo build --release

      - name: Strip binary
        run: strip target/release/cert-tree || true

      - name: Build RPM package
        run: |
          . $HOME/.cargo/env
          cargo generate-rpm
          VERSION="${{ needs.validate.outputs.version }}"
          mv target/generate-rpm/cert-tree-${VERSION}-1.x86_64.rpm \
            target/generate-rpm/cert-tree-${{ matrix.distro }}-${VERSION}-1.x86_64.rpm

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.distro }}-rpm
          path: target/generate-rpm/cert-tree-${{ matrix.distro }}-*.rpm
          if-no-files-found: error

  # Build DEB packages
  build-deb:
    name: Build DEB for ${{ matrix.distro }}
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - distro: debian
            container: debian:latest
          - distro: ubuntu
            container: ubuntu:latest
    container: ${{ matrix.container }}
    steps:
      - name: Install dependencies
        run: |
          apt update -y
          apt install -y curl build-essential libssl-dev pkg-config
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . $HOME/.cargo/env
          cargo install cargo-deb

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release
        run: |
          . $HOME/.cargo/env
          cargo build --release

      - name: Strip binary
        run: strip target/release/cert-tree || true

      - name: Build DEB package
        run: |
          . $HOME/.cargo/env
          cargo deb
          VERSION="${{ needs.validate.outputs.version }}"
          mv target/debian/cert-tree_${VERSION}-1_amd64.deb \
            target/debian/cert-tree-${{ matrix.distro }}-${VERSION}-1_amd64.deb

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.distro }}-deb
          path: target/debian/cert-tree-${{ matrix.distro }}-*.deb
          if-no-files-found: error

  # Create GitHub release
  release:
    name: Create GitHub Release
    needs:
      - validate
      - build-linux
      - build-macos-intel
      - build-macos-arm
      - build-rpm
      - build-deb
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: |
          echo "Artifact structure:"
          ls -R artifacts/

      - name: Extract changelog for this version
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          
          # Extract changelog section for this version
          awk "/^## \\[${VERSION}\\]/{flag=1; next} /^## \\[/{flag=0} flag" CHANGELOG.md > changelog_section.md
          
          # Check if changelog section exists
          if [ ! -s changelog_section.md ]; then
            echo "âš ï¸ Warning: No changelog section found for version ${VERSION}"
            echo "No changelog available for this version." > changelog_section.md
          fi

      - name: Generate release notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          
          cat > release_notes.md << 'EOF'
          # ðŸŽ‰ cert-tree v$VERSION
          
          **Released:** $DATE
          
          ## ðŸ“¦ Downloads
          
          ### ðŸ§ Linux
          - **Binary**: `cert-tree-$VERSION-linux-x86_64.tar.gz`
          - **RPM**: CentOS, Rocky, Alma packages available
          - **DEB**: Debian, Ubuntu packages available
          
          ### ðŸŽ macOS
          - **Intel**: `cert-tree-$VERSION-macos-x86_64.tar.gz`
          - **Apple Silicon**: `cert-tree-$VERSION-macos-aarch64.tar.gz`
          
          ## ðŸš€ Quick Start
          
          ### Binary Installation
          ```bash
          # Extract
          tar -xzf cert-tree-$VERSION-*.tar.gz
          cd cert-tree-*/
          
          # Run
          ./cert-tree --help
          ```
          
          ### Package Manager
          ```bash
          # Ubuntu/Debian
          sudo dpkg -i cert-tree-ubuntu-$VERSION-1_amd64.deb
          
          # CentOS/RHEL/Rocky/Alma
          sudo rpm -i cert-tree-centos-$VERSION-1.x86_64.rpm
          ```
          
          ### Version Manager (mise)
          ```bash
          mise use -g github:tdslot/cert-tree.rs
          ```
          
          ## ðŸ“– Usage Examples
          
          ```bash
          # Inspect certificate file
          cert-tree --file certificate.pem
          
          # Check website certificate
          cert-tree --url https://example.com
          
          # Interactive mode
          cert-tree --file certificate.pem --interactive
          ```
          
          ## ðŸ“‹ Changelog
          
          EOF
          
          # Replace variables in template
          sed -i "s/\$VERSION/${VERSION}/g" release_notes.md
          sed -i "s/\$DATE/${DATE}/g" release_notes.md
          
          # Append changelog section
          cat changelog_section.md >> release_notes.md
          
          # Add footer
          cat >> release_notes.md << 'EOF'
          
          ---
          
          ## ðŸ”— Links
          - ðŸ“– [Documentation](https://github.com/tdslot/cert-tree.rs/blob/main/README.md)
          - ðŸ› [Report Issues](https://github.com/tdslot/cert-tree.rs/issues)
          - ðŸ’¬ [Discussions](https://github.com/tdslot/cert-tree.rs/discussions)
          
          **Full Changelog**: https://github.com/tdslot/cert-tree.rs/blob/main/CHANGELOG.md
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          body_path: release_notes.md
          tag_name: ${{ github.ref }}
          name: cert-tree v${{ needs.validate.outputs.version }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
